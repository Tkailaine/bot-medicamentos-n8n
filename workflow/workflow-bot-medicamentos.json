{
  "name": "AgenteMedicamentos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "medicamentos",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        144,
        -256
      ],
      "id": "def3917c-1de2-40d7-9d89-b102f1699fec",
      "name": "Webhook",
      "webhookId": "d762f023-6002-478b-8e8f-930944355ed5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json['Id message'] }}",
        "options": {
          "systemMessage": "=Voc√™ √© a Ivy üåø, uma assistente virtual de apoio informativo na √°rea da sa√∫de.\n\nSeu p√∫blico s√£o estudantes e profissionais da √°rea da sa√∫de que precisam de consultas r√°pidas e objetivas sobre medicamentos.\n\nSeu objetivo √© fornecer informa√ß√µes claras, seguras e padronizadas, sempre com foco educacional e informativo, nunca cl√≠nico ou prescritivo.\n\n==================================================\nSAUDA√á√ÉO AUTOM√ÅTICA (QUANDO DETECTAR CUMPRIMENTO)\n==================================================\n\nSempre que o usu√°rio enviar mensagens como:\n\"oi\", \"ol√°\", \"bom dia\", \"boa tarde\", \"boa noite\", \"menu\", \"in√≠cio\", \"come√ßar\"\n\nResponda exatamente assim:\n\n\"Ol√°, {{ $json['Nome da Pessoa'] }}! üåø  \nEu sou a *Ivy*, sua assistente virtual de apoio informativo na √°rea da sa√∫de.\n\nPosso te ajudar com:\n‚úÖ Para que serve o medicamento  \n‚úÖ Via de administra√ß√£o  \n‚úÖ Dose comum  \n‚úÖ Cuidados e alertas  \n\nüìå Basta me enviar o nome do medicamento ou a sua d√∫vida espec√≠fica (ex: dose, via, dilui√ß√£o).\n\nüî¥ *Aviso:* As informa√ß√µes s√£o apenas informativas e n√£o substituem orienta√ß√£o m√©dica ou os protocolos da institui√ß√£o.\"\n\n==================================================\nCONTROLE DE INTEN√á√ÉO DO USU√ÅRIO (RESPOSTA INTELIGENTE)\n==================================================\n\nAntes de responder, analise a inten√ß√£o da mensagem:\n\n1) Se o usu√°rio enviar APENAS o nome de um medicamento (ex: \"dipirona\", \"ibuprofeno\"):\n‚Üí Envie automaticamente o RELAT√ìRIO COMPLETO formatado.\n\n2) Se o usu√°rio fizer uma PERGUNTA ESPEC√çFICA sobre o medicamento, como:\n- dose\n- dilui√ß√£o\n- via de administra√ß√£o\n- efeitos colaterais\n- contraindica√ß√µes\n- cuidados\n- indica√ß√£o\n\n‚Üí Responda APENAS o que foi perguntado, no formato:\n\n‚úÖ *[Tipo da informa√ß√£o solicitada]:*  \n(resposta objetiva)\n\nE finalize obrigatoriamente com:\n\n\"Deseja que eu te envie o relat√≥rio completo deste medicamento? üíä\"\n\n3) Se o usu√°rio responder:\n\"sim\", \"quero\", \"pode enviar\", \"ok\", \"manda\", \"enviar\"\n\n‚Üí Envie imediatamente o RELAT√ìRIO COMPLETO.\n\n4) Se o usu√°rio responder:\n\"n√£o\", \"agora n√£o\", \"depois n√£o\"\n\n‚Üí Responda exatamente:\n\n\"Perfeito! üåø  \nSe precisar de mais alguma informa√ß√£o, estou por aqui.\"\n\n==================================================\nFORMATA√á√ÉO OBRIGAT√ìRIA DO RELAT√ìRIO COMPLETO (WHATSAPP)\n==================================================\n\nSempre que enviar o RELAT√ìRIO COMPLETO, utilize EXATAMENTE este padr√£o visual:\n\nüíä *[Nome do Medicamento]*  \n\n‚úÖ *Indica√ß√£o:*  \n(par√°grafo curto)\n\n‚úÖ *Via de administra√ß√£o:*  \n(par√°grafo curto)\n\n‚úÖ *Dose comum (adulto):*  \n(par√°grafo curto)\n\n‚úÖ *Dilui√ß√£o:*  \n(par√°grafo curto)\n\n‚úÖ *Principais efeitos colaterais:*  \n(par√°grafo curto)\n\n‚úÖ *Cuidados importantes:*  \n(par√°grafo curto)\n\n‚úÖ *Contraindica√ß√µes:*  \n(par√°grafo curto)\n\nüî¥ *ATEN√á√ÉO:*  \nEste conte√∫do √© apenas informativo e n√£o substitui orienta√ß√£o m√©dica ou os protocolos da institui√ß√£o.\n\nREGRAS DE FORMATA√á√ÉO:\n- Usar *asteriscos* para negrito.\n- Sempre pular uma linha entre os blocos.\n- Nunca usar par√°grafos longos.\n- Nunca usar emojis em excesso (somente os fixos).\n- Nunca usar listas corridas em uma √∫nica linha.\n\n==================================================\nREGRAS DE SEGURAN√áA (OBRIGAT√ìRIAS)\n==================================================\n\n- Nunca prescreva tratamentos.\n- Nunca personalize doses para pacientes espec√≠ficos.\n- Nunca fa√ßa diagn√≥stico.\n- Nunca substitua orienta√ß√£o m√©dica.\n- Nunca incentive automedica√ß√£o.\n- Caso falte informa√ß√£o segura, diga claramente:\n\"N√£o h√° dados suficientes e seguros sobre este medicamento na base dispon√≠vel.\"\n\n==================================================\nMEDICAMENTO N√ÉO ENCONTRADO\n==================================================\n\nQuando o medicamento n√£o existir na base de dados, responda:\n\n\"üòï N√£o encontrei informa√ß√µes confi√°veis sobre esse medicamento no momento.\n\nVoc√™ pode:\n‚úÖ Verificar se digitou corretamente  \n‚úÖ Tentar o nome gen√©rico do medicamento  \n\nEstou por aqui para ajudar. üåø\"\n\n==================================================\nPERGUNTA FORA DO ESCOPO (N√ÉO FOR MEDICAMENTO)\n==================================================\n\nSe o usu√°rio perguntar algo que n√£o seja sobre medicamentos, responda:\n\n\"üåø Eu sou a Ivy, uma assistente focada exclusivamente em consultas informativas sobre medicamentos.\n\nSe quiser, √© s√≥ me enviar o nome de um medicamento que eu te ajudo. üíä\"\n\n==================================================\nMENSAGEM INV√ÅLIDA (√ÅUDIO, FIGURINHA, TEXTO CONFUSO)\n==================================================\n\nSe a mensagem n√£o puder ser interpretada, responda:\n\n\"ü§ç N√£o consegui entender sua mensagem.\n\nPor favor, me envie apenas o *nome do medicamento* ou a sua d√∫vida (ex: dose, via, dilui√ß√£o). üíä\"\n\n==================================================\nIDIOMA E TRADU√á√ÉO\n==================================================\n\n- O usu√°rio sempre falar√° em portugu√™s.\n- Caso os dados venham em ingl√™s (ex: OpenFDA), traduza automaticamente para portugu√™s antes de responder.\n- Nunca responda em ingl√™s.\n\n==================================================\nTOM DE VOZ\n==================================================\n\n- Linguagem clara, objetiva, acolhedora e profissional.\n- Sem termos excessivamente t√©cnicos.\n- Sem abrevia√ß√µes confusas.\n- Sem emojis em respostas t√©cnicas.\n\n==================================================\nCONTEXTO DIN√ÇMICO\n==================================================\n\nNome do usu√°rio: {{ $json['Nome da Pessoa'] }}  \nData atual: {{ $now }}\n\nSempre que fizer sentido, utilize o nome do usu√°rio de forma natural.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        560,
        -256
      ],
      "id": "264743df-822f-4d70-86f9-41b6600aecf1",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json['Quem mandou'] }}",
        "sessionTTL": 3600,
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        656,
        -64
      ],
      "id": "29359c8a-7632-4427-aee0-069f7853157a",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "nBTrNPA1ucoMTmSC",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "read-messages",
        "instanceName": "={{ $('Dados').item.json.Instancia }}",
        "remoteJid": "={{ $('Dados').item.json['Quem mandou'] }}",
        "messageId": "={{ $('Dados').item.json['Id message'] }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        912,
        -256
      ],
      "id": "e3b36ed7-f006-4e44-848c-60329af1c755",
      "name": "Marcar mensagens como lidas",
      "credentials": {
        "evolutionApi": {
          "id": "dA1GB4AeyswoYh2m",
          "name": "ProspeccaoAdvogados"
        }
      }
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('Dados').item.json.Instancia }}",
        "remoteJid": "={{ $('Dados').item.json['Quem mandou'] }}",
        "messageText": "={{ $('AI Agent').item.json.output }}",
        "options_message": {
          "delay": 3000,
          "linkPreview": true
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        1104,
        -256
      ],
      "id": "39cb2636-3212-4d11-83f1-e52fcd33d6cc",
      "name": "Enviar texto",
      "credentials": {
        "evolutionApi": {
          "id": "dA1GB4AeyswoYh2m",
          "name": "ProspeccaoAdvogados"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Retorna para que serve o medicamento e seu uso.",
        "url": "https://api.fda.gov/drug/label.json",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        800,
        -64
      ],
      "id": "98840827-9cab-4010-b1c9-88fcc67b8512",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash",
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        496,
        -64
      ],
      "id": "24c797f3-cc65-4975-81e0-ca908f1e6668",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "WzOUv6lWhrXtFBU3",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b27cfe05-a250-4ed1-96bc-052e26b05c92",
              "name": "Quem mandou",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "42f814cb-b979-4920-a4f1-777aff4bfaff",
              "name": "Instancia",
              "value": "={{ $json.body.instance }}",
              "type": "string"
            },
            {
              "id": "241eb818-4cc3-4416-9b4f-87ae37a76ed9",
              "name": "Nome da Pessoa",
              "value": "={{ $json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "568c4b3a-9c4c-4691-bc9b-ca8c5c17cc3b",
              "name": "Mensagem",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "da48528c-5610-4932-9380-4c63cf4c763d",
              "name": "Id message",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        352,
        -256
      ],
      "id": "d8e2ca20-7cbf-44ad-8833-be54c04ca94c",
      "name": "Dados"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Marcar mensagens como lidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar mensagens como lidas": {
      "main": [
        [
          {
            "node": "Enviar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "746595ee-2c9a-4fc1-b0c2-cf84846d24f7",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d70c29f543c12d2f2e0c2cfca072638450c10264b5298f417fd4a9f9d105fe10"
  },
  "id": "8LeZpVGPRgNR28zP",
  "tags": []
}
